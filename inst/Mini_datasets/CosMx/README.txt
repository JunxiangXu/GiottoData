




## Script to generate mini CosMx data from Lung12 CosMx data ##


library(Giotto)library(data.table)## provide path to nanostring folderdata_path = "/projectnb/rd-spat/DATA/Public_data/Nanostring/Lung12/Lung12-Flat_files_and_images/"list.files(data_path)# results folder and new minidataset folderresults_folder = '/projectnb/rd-spat/HOME/Ruben/Projects/Lab/2023_mini_cosmx'minidataset_folder = paste0(results_folder,'/','Minidata')cellcomposite_folder = paste0(minidataset_folder,'/','CellComposite')dir.create(cellcomposite_folder, recursive = T)celllabels_folder = paste0(minidataset_folder,'/','CellLabels')dir.create(celllabels_folder, recursive = T)## 1. CREATION ###### offset file ###### ------------ ###  load field of vision (fov) positionsfov_offset_file = data.table::fread(paste0(data_path, 'Lung12_fov_positions_file.csv'))mini_fov_offset_file = fov_offset_file[fov %in% 2:3]fwrite(x = mini_fov_offset_file, file = paste0(minidataset_folder, '/', 'Lung12_fov_positions_file.csv'))# composite image & cell segmentationscrop_ext02 = terra::ext(c(4800, 5472, 3000, 3648))crop_ext03 = terra::ext(c(0, 672, 3000, 3648))## composites ###### ------------ ### composite image for 02original_composite_image02 = paste0(data_path, 'CellComposite/CellComposite_F0', '02','.jpg')comp02 = terra::rast(original_composite_image02)plot(comp02)comp02_crop = terra::crop(x = comp02, y = crop_ext02)plot(comp02_crop)terra::writeRaster(x = comp02_crop,                   filetype = 'JPEG', filename = paste0(cellcomposite_folder,'/','CellComposite_F002.jpg'),                   gdal = c('QUALITY=95'), overwrite = TRUE)?terra::writeRaster# composite image for 03original_composite_image03 = paste0(data_path, 'CellComposite/CellComposite_F0', '03','.jpg')comp03 = terra::rast(original_composite_image03)plot(comp03)comp03_crop = terra::crop(x = comp03, y = crop_ext03)plot(comp03_crop)terra::writeRaster(x = comp03_crop,                   filetype = 'JPEG', filename = paste0(cellcomposite_folder,'/','CellComposite_F003.jpg'),                   gdal = c('QUALITY=95'), overwrite = TRUE)## segmentation masks ###### -------------------- ### segmentation for 02segmentation_mask02 = paste0(data_path, 'CellLabels/CellLabels_F0', '02', '.tif')terra_rast02 = terra::rast(segmentation_mask02)plot(terra_rast02)terra_rast02_crop = terra::crop(x = terra_rast02, y = crop_ext02)plot(terra_rast02_crop)terra::writeRaster(x = terra_rast02_crop,                   filetype = 'GTiff', filename = paste0(celllabels_folder,'/','CellLabels_F002.tif'),                   gdal = c('COMPRESS=NONE'), overwrite = TRUE)# segmentation for 03segmentation_mask03 = paste0(data_path, 'CellLabels/CellLabels_F0', '03', '.tif')terra_rast03 = terra::rast(segmentation_mask03)plot(terra_rast03)terra_rast03_crop = terra::crop(x = terra_rast03, y = crop_ext03)plot(terra_rast03_crop)terra::writeRaster(x = terra_rast03_crop,                   filetype = 'GTiff', filename = paste0(celllabels_folder,'/','CellLabels_F003.tif'),                   gdal = c('COMPRESS=NONE'), overwrite = TRUE)## transcript coordinates ###### ------------------------ ##tx_coords = data.table::fread(paste0(data_path,'/','Lung12_tx_file.csv'))mini_tx_coords = tx_coords[fov %in% 2:3]mini_tx_coords[, range(x_local_px), by = .(fov)]mini_tx_coords[, range(y_local_px), by = .(fov)]mini_tx_coords_02 = mini_tx_coords[fov == 2 & x_local_px > 4800 & x_local_px < 5472 & y_local_px > 3000 & y_local_px < 3648]mini_tx_coords_03 = mini_tx_coords[fov == 3 & x_local_px > 0 & x_local_px < 672 & y_local_px > 3000 & y_local_px < 3648]mini_tx_coords_final = rbindlist(list(mini_tx_coords_02, mini_tx_coords_03))fwrite(x = mini_tx_coords_final, file = paste0(minidataset_folder, '/', 'Lung12_tx_file.csv'))